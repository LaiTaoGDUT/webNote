### 亮点

1. 为前端内部的代码发布平台开发了自动化合并构建代码自动发布的功能，测试和灰度环境发布代码，只需要在push了开发分支代码后，到发布平台点一下自动发布，即可去做别的事情，代码构建发布成功后，推送企微通知，收到通知后进行验收。









### 难点

1. 按钮点击后延迟播放视频问题

周年活动会在点击一个开始回顾按钮后，等待算法侧生成周年回顾视频并返回url，期间需要等待10s左右，然后再开始播放这个视频，然后就发现很多手机播放不了。

那个时候其实同事也对web的视频播放了解比较少，所以就系统的进行了一波学习，深入了解了web页面自动播放音视频的原则和限制，在学习的过程中也知道了上面那个播不了的答案，这个媒体播放的手势令牌是有时间限制的，如果你在点击的回调函数上，不立即开始视频播放，而是延迟一段时间再播，就不给播了，发现解决方案竟然是在调用play之前，先调用一下load，而且回调函数不能是async函数。

[网页视频autoplay兼容及解决方案](https://github.com/bigo-frontend/blog/issues/88)

2. svga解压耗时长阻塞主线程问题

lucky slot小游戏内含有两个体积较大的svga获奖动画，使用yy提供的web播放库，小游戏进入时的加载页面会加载游戏素材和一些获奖动画，由于这个播放库在加载svga完成后会立即进行svga的解压工作，而这个工作是同步的，每个svga文件的解压都会堵塞主线程1s左右，所以上线之后发现不管你网络多好或者缓存多好，都得在加载页面等个两秒以上才能进去玩游戏

我接到这个优化工作之后，首先看performace分析知道了堵塞源头是这个播放库的解压方法，然后我把库下载下来开始研究，首先想到的是把加载和解压分开，让这两个步骤可以单独调用，然后我就可以在加载页先只进行文件的加载，这样加载过程就变快了，解压工作可以在用户空闲的时候或者得奖了需要播放动画之前才去解压，那么就把源码给改了，增加参数支持加载和解压的分离调用，然后在进入加载页面后初始化一个定时器，2s后如果用户没有玩游戏的动作，就解压一个动画，再过2s用户还没玩游戏，就再解压下一个动画，或者在播放动画之前解压动画，这样优化上线过后，首屏成功率升了好多个百分点，比之前好一点了，用户等待玩游戏的时间变短了。

但是到现在还是不是做的特别好，因为解压始终是阻塞过程，不管什么时候解压，在解压的1s内，页面都是卡顿状态，如果用户在这个时候刚好想玩游戏，就会感觉页面卡了，或者是播放动画前解压，用户也会感觉播放动画有点卡，甚至你想搞个解压的全局loading，都做不到，因为会卡顿。

想到这种耗时操作，就自然而然想到了webworker，又因为改造了播放库之后，解压方法其实是不依赖dom的，就是传一个blob数据去解压，然后返回一个可以给播放库播放的对象，就是单纯的数据输入处理输出，所有就想到把解压放到webworker里，就是封装一个更高层的解压方法，调用解压方法的时候，里面初始化一个worker，同时存一个任务id，返回一个promise给外层，等worker加载成功后就通知worker帮忙解压一下这个文件，worker解压完成或者失败后，再通知回来，带上解压后的播放对象以及任务id，收到消息之后，将这个任务id对应的promise给resolve，如果worker加载失败，回退到主线程解压就行了，那么这时候就搞定了一个不堵塞主线程的解压方法，而且不需要修改主流程的任何代码，只需要替换一下解压方法就行了，此时要修改一下解压逻辑的触发时机，在加载svga完成后，就可以立马调用解压方法了，然后在播放动画之前，假如解压还没成功，就展示一波loading等解压成功后播放，这样一波操作之后，加载时间变短了，而且也不会让用户偶尔觉得游戏卡顿。

3. 代码优化，目前运营后台的开发模式有一部分是前端开发页面，java后端开发接口，node层只作为登录态验证与权限验证，并将前端的业务请求转发到java接口层，于是给运营增加了一个按配置生成转发代码的功能，对每个java接口请求，配置一下目标url，入参出参，然后就自动生成前端的调用接口代码和node层的转发接口代码，不需要每次都再手写重复的转发代码，前端services，node的router层，controller层等，避免无意义的重复。然后到现在还支持自定义参数验证，自定义中间件等功能，满足越来越多的花式转发需求。