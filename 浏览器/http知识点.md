

### 一、HTTP 概述
1. **定义与作用**：HTTP 是一种用于分布式、协作式和超媒体信息系统的应用层协议，用于客户端和服务器之间传输超文本（如 HTML 页面、图片、视频等）。

2. **版本**：常见版本有 HTTP/1.0、HTTP/1.1、HTTP/2 和 HTTP/3。不同版本在性能、功能和效率等方面存在差异。

### 二、HTTP 连接过程（以 HTTP/1.1 为例）
1. **DNS 解析**：客户端首先通过 DNS 服务器将目标服务器的域名解析为对应的 IP 地址。例如，访问`www.example.com`时，需要将`www.example.com`解析为具体的 IP。

2. **TCP 连接建立**：客户端与服务器之间通过三次握手建立 TCP 连接。

    - 客户端发送一个 SYN 包（同步序列号）到服务器，请求建立连接，此时客户端进入 SYN_SENT 状态。

    - 服务器收到 SYN 包后，向客户端发送一个 SYN-ACK 包（同步确认包），表示同意建立连接，服务器进入 SYN_RCVD 状态。

    - 客户端收到 SYN-ACK 包后，向服务器发送一个 ACK 包（确认包），完成连接建立，客户端和服务器都进入 ESTABLISHED 状态。

        TCP采用三次握手建立连接主要有以下几个原因：

        - **相互告知序列号值**
            - 为了实现可靠数据传输， TCP 协议的通信双方， 都必须维护一个序列号， 以标识发送出去的数据包中， 哪些是已经被对方收到的。 三次握手的过程即是通信双方相互告知序列号起始值， 并确认对方已经收到了序列号起始值的必经步骤。

            - 客户端发送第一次握手，带客户端请求序号X，服务器返回第二次握手带响应序号X + 1，同时带服务端请求序号Y，客户端第三次握手带请求序号X + 1和响应序号Y + 1（最后一次握手不消耗客户端的序号，所以客户端的下一次请求，请求序号还是带X + 1）

        - **防止历史连接干扰**
            - 若采用两次握手，当网络中存在延迟的旧连接请求报文时，可能会引发问题。例如，客户端发送的第一个连接请求报文在网络中滞留，导致客户端超时重传并成功建立连接。之后，原滞留的请求报文到达服务器，服务器会误认为是新的连接请求并发送确认，此时若没有第三次握手，连接就会错误地建立，而客户端并不会认为这是一个新连接，从而导致数据传输错误。

            - 三次握手可以避免这种情况。客户端发送第一次握手，带一个初始序号X，服务器发送确认带X + 1，然后客户端可以根据确认的序号来判断这个连接是否过期，若是则忽略，不会建立错误连接。

        - **确保双方具备收发能力**
            - 第一次握手，客户端向服务器发送SYN包，表明客户端具有发送数据的能力。

            - 第二次握手，服务器收到SYN包后，向客户端发送SYN - ACK包，这表明服务器收到了客户端的SYN包，且服务器具有接收和发送数据的能力。

            - 第三次握手，客户端向服务器发送ACK包，服务器收到后，知道客户端收到了服务器的SYN - ACK包，即客户端也具备接收数据的能力。通过三次握手，双方都确认了彼此能够正常地接收和发送数据。


3. **发送 HTTP 请求**：客户端在建立好的 TCP 连接上发送 HTTP 请求报文，请求报文中包含请求方法（如 GET、POST 等）、请求的资源路径、HTTP 版本号、请求头和请求体（可选）等信息。


4. **服务器处理请求**：服务器接收到客户端的请求后，根据请求方法和资源路径进行相应的处理。例如，若请求的是一个 HTML 页面，服务器会查找并准备好该页面数据。

5. **发送 HTTP 响应**：服务器将处理结果封装成 HTTP 响应报文，通过已建立的 TCP 连接发送给客户端。响应报文包含状态码、状态描述、响应头和响应体（可选）等信息。

6. **关闭连接**：数据传输完成后，客户端和服务器可以通过四次挥手关闭 TCP 连接。

    - 客户端发送一个 FIN 包（结束标志），请求关闭连接，客户端进入 FIN_WAIT_1 状态。

    - 服务器收到 FIN 包后，发送一个 ACK 包确认收到关闭请求，服务器进入 CLOSE_WAIT 状态，客户端进入 FIN_WAIT_2 状态。

    - 服务器处理完剩余数据后，发送一个 FIN 包给客户端，请求关闭连接，服务器进入 LAST_ACK 状态。

    - 客户端收到服务器的 FIN 包后，发送一个 ACK 包确认关闭，客户端进入 TIME_WAIT 状态，服务器进入 CLOSED 状态。一段时间后，客户端也进入 CLOSED 状态，连接彻底关闭。

    TCP连接采用四次挥手来释放连接，主要有以下原因：

    - **确保双方数据传输完成**

    - 当一方（如客户端）想要关闭连接时，它首先发送一个FIN包给对方（服务器），表示自己已经没有数据要发送了，但客户端可能还需要接收服务器发送的数据。

    - 服务器收到FIN包后，会发送一个ACK包进行确认，此时服务器进入CLOSE_WAIT状态，意味着服务器已经知道客户端要关闭连接，但服务器可能还有数据未发送完。

    - 当服务器将剩余的数据发送完后，会发送一个FIN包给客户端，告知客户端自己也没有数据要发送了。

    - 客户端收到服务器的FIN包后，再发送一个ACK包进行确认，至此，双方都确认没有数据要传输，连接正式关闭。

    - **保证连接关闭的可靠性**
    
    - 四次挥手的过程中，每一次的FIN和ACK都有明确的确认机制。通过这种多次的交互和确认，能够确保双方都能准确地知晓对方的关闭意图和连接状态，避免因为网络延迟、丢包等问题导致连接关闭出现异常。如果改成两次挥手，加入客户端发送的第一次挥手FIN包丢失，服务器不会收到关闭连接的信号，就会继续保持连接并等待客户端发送数据，而客户端也不能知道服务端到底此时没有收到挥手请求，也会继续等服务端发送的FIN包。通过四次挥手和确认机制，可以最大程度地避免这种情况的发生，保证连接关闭的可靠性和稳定性。

### 三、HTTP 报文

1. **请求报文**：由请求行、请求头、请求体（可选）组成。

    - **请求行**：包含请求方法（如 GET、POST、PUT、DELETE 等）、请求的资源路径和 HTTP 版本号。

    - **请求头**：包含各种元数据，如 User-Agent（客户端信息）、Content-Type（请求体数据类型）、Cookie 等。

    - **请求体**：在使用 POST、PUT 等方法时，包含要发送给服务器的数据，如表单数据、JSON 数据等。

2. **响应报文**：由状态行、响应头、响应体（可选）组成。

    - **状态行**：包含 HTTP 版本号、状态码（如 200、404、500 等）和状态描述。

    - **响应头**：提供关于响应的额外信息，如 Content-Type、Content-Length、Set-Cookie 等。

    - **响应体**：包含服务器返回给客户端的数据，如 HTML 页面内容、错误信息等。

### 四、HTTP 状态码

1. **1xx（信息性状态码）**：表示临时响应，需要客户端继续执行操作，如 100（继续）。

2. **2xx（成功状态码）**：表示请求已成功被服务器接收、理解并处理，如 200（成功）、201（已创建）。

3. **3xx（重定向状态码）**：表示需要客户端采取进一步的操作才能完成请求，如 301（永久重定向）、302（临时重定向）。

4. **4xx（客户端错误状态码）**：表示客户端出错，如 400（错误请求）、401（未授权）、403（禁止访问）、404（未找到）。

5. **5xx（服务器错误状态码）**：表示服务器在处理请求时发生了错误，如 500（内部服务器错误）、502（错误网关）、503（服务不可用）。

### 五、HTTP 方法

1. **GET**：用于请求获取指定资源，数据通过 URL 传递，一般不包含请求体。

2. **POST**：用于向服务器提交数据，数据包含在请求体中，常用于提交表单、上传文件等。

3. **PUT**：用于更新指定资源，将请求体中的数据替换服务器上的资源。
4. **DELETE**：用于删除指定资源。

5. **HEAD**：与 GET 类似，但只返回响应头，不返回响应体，常用于获取资源的元信息。

6. **OPTIONS**：用于获取服务器支持的 HTTP 方法列表，以及其他相关信息。

### 六、HTTP 连接管理

1. **短连接**：每次请求都建立一个新的 TCP 连接，请求完成后关闭连接，适用于请求较少的场景。

2. **长连接（持久连接）**：多个请求可以复用同一个 TCP 连接，减少连接建立和关闭的开销，提高性能。在 HTTP/1.1 中默认启用。

3. **连接池**：维护一组已建立的 TCP 连接，客户端可以从连接池中获取连接进行请求，提高连接的复用率。

### 七、HTTP 缓存
1. **缓存位置**：分为浏览器缓存、代理服务器缓存、网关缓存等。

2. **缓存机制**：

    - **强缓存**：客户端根据缓存过期时间（Expires、Cache-Control 字段）判断是否直接使用缓存，无需向服务器发送请求。

    - **协商缓存**：客户端向服务器发送请求，服务器根据缓存标识（Last-Modified/If-Modified-Schema、ETag/If-None-Match 字段）判断资源是否有更新，若未更新则返回 304 状态码，客户端使用缓存数据。

### 八、HTTP/2 特性

1. <span style="background-color: yellow;">**二进制分帧层**：将数据分割为帧，并对帧进行二进制编码，提高传输效率。</span>


2. <span style="background-color: yellow;">**多路复用**：多个请求和响应可以在同一个 TCP 连接上同时进行，避免了 HTTP/1.1 中的队头阻塞问题。</span>

3. **头部压缩**：使用 HPACK 算法对请求和响应头部进行压缩，减少数据传输量。

4. **服务器推送**：服务器可以主动向客户端推送资源，无需客户端显式请求。

### 九、HTTP/3 特性

1. **基于 UDP 的 QUIC 协议**：使用 UDP 作为传输层协议，实现了低延迟、高可靠性的数据传输，减少了连接建立时间。

2. **连接迁移**：在网络环境变化时，允许连接在不同网络接口之间无缝迁移，保持连接的连续性。

3. **前向纠错**：通过在数据中添加冗余信息，提高数据传输的可靠性，减少重传次数。

### 十、HTTP 与 HTTPS 的区别

1. **安全性**：HTTPS 是 HTTP 的安全版本，通过 SSL/TLS 协议对数据进行加密传输，防止数据被窃取和篡改，而 HTTP 数据以明文传输。

2. **连接方式**：HTTP 默认使用 80 端口，HTTPS 使用 443 端口。

3. **证书**：HTTPS 需要服务器安装数字证书，以验证服务器的身份，HTTP 不需要。

4. **性能**：由于加密和解密操作，HTTPS 的性能开销相对较大，但现代浏览器和服务器对性能进行了优化。 

    **TLS/SSL握手阶段**：

    - **服务器向CA申请证书**：服务器先向CA机构申请https连接的证书，包括域名，过期时间等信息，CA使用私钥加密这些信息成为签名，将证书连同签名给到服务器。

    - **客户端发送ClientHello消息**：在TCP连接建立后，客户端开始TLS/SSL握手，向服务器发送一个ClientHello消息，其中包含了客户端支持的TLS/SSL版本、加密算法套件列表、**客户端的随机数**等信息。

    - **服务器发送ServerHello消息**：服务器收到ClientHello消息后，从客户端提供的选项中选择一个合适的TLS/SSL版本和加密算法套件，并向客户端发送ServerHello消息，其中包含服务器选择的TLS/SSL版本、加密算法套件、**服务器的随机数**等信息。

    - **服务器发送证书**：服务器向客户端发送自己的数字证书，证书包含了服务器的公钥、服务器的身份信息（如域名）以及CA的签名。

    - **客户端验证证书**：客户端内置一系列受信任的证书，收到服务器的证书后，使用CA的公钥去解密证书签名，验证证书的有效性，包括检查证书是否过期、证书的颁发机构是否受信任、证书中的域名是否与服务器的实际域名匹配等。

    - **客户端发送预主密钥**：如果证书验证通过，客户端生成一个预主密钥（Pre-Master Secret），用服务器的公钥加密后发送给服务器。

    - **双方计算主密钥**：客户端和服务器各自根据预主密钥、双方的随机数等信息计算出一个相同的主密钥（Master Secret）。后续的加密通信将使用这个主密钥生成的会话密钥来进行对称加密。

完成以上步骤后，客户端和服务器之间就建立了一个安全的HTTPS连接，可以进行加密的数据传输了。 

